name: Claude Issue Processor

on:
  issues:
    types: [opened]

jobs:
  process-issue:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            .github
            .claude
            CODE_OF_CONDUCT.md
          sparse-checkout-cone-mode: false

      - name: Process issue with Claude
        id: claude-processor
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          prompt: |
            A new GitHub issue has been created and needs to be processed through the full issue intake pipeline using the github-issue-manager agent.

            Here are the issue details:

            REPO: ${{ github.repository }}
            ISSUE_NUMBER: ${{ github.event.issue.number }}
            ISSUE_TITLE: ${{ github.event.issue.title }}
            ISSUE_AUTHOR: ${{ github.event.issue.user.login }}
            ISSUE_LABELS: ${{ join(github.event.issue.labels.*.name, ', ') }}
            ISSUE_TEMPLATE_USED:

            First, read the full issue body using:
            gh issue view ${{ github.event.issue.number }} --repo ${{ github.repository }} --json body --jq .body

            Then process this issue through the github-issue-manager pipeline by calling these four skills sequentially, passing the required variables to each:

            1. /identify-security-vuln-discussion — Pass: REPO, ISSUE_NUMBER, ISSUE_TITLE, ISSUE_BODY, ISSUE_AUTHOR
               Screen for inadvertent security vulnerability disclosure. If found, tag @productsecurityteam and close the issue.

            2. /code-of-conduct-check — Pass: REPO, ISSUE_NUMBER, ISSUE_TITLE, ISSUE_BODY, ISSUE_AUTHOR
               Evaluate against the repository's code of conduct. Sanitize violations while preserving technical content.

            3. /issue-template-validation — Pass: REPO, ISSUE_NUMBER, ISSUE_TITLE, ISSUE_BODY, ISSUE_AUTHOR, ISSUE_TEMPLATE_USED
               Verify correct template usage. Reformat to the appropriate template if needed.

            4. /assign-label — Pass: REPO, ISSUE_NUMBER, ISSUE_TITLE, ISSUE_BODY, ISSUE_LABELS
               Assign the most appropriate label(s) from the repository's available labels.

            Important:
            - Execute each step sequentially in the exact order above
            - If any step modifies the issue body, use the updated body for all subsequent steps
            - If Step 1 closes the issue due to a security vulnerability, skip all remaining steps
            - Provide a final summary of all actions taken across all steps

          claude_args: '--allowed-tools "Bash(gh *),Read,Grep,Glob"'
