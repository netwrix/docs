name: Validate Branch History

on:
  push:
    branches:
      - '**'
  pull_request:
    types: [opened, synchronize, reopened]

env:
  SECURITY_CONTACT: 'jake-mahon-netwrix'

jobs:
  validate-history:
    name: Validate Clean History
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      pull-requests: write
      issues: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check branch ancestry
        id: check_ancestry
        run: |
          # Valid root commits
          VALID_ROOTS=(
            "97e73c5cc4a29296024f23499ef5e60bc7db755b"
          )

          echo "üîç Validating branch ancestry..."

          # Get ALL root commits (handles merged branches with multiple roots)
          BRANCH_ROOTS=$(git rev-list --max-parents=0 HEAD)

          echo "Found root commit(s):"
          echo "$BRANCH_ROOTS"

          # Check each root commit
          INVALID_ROOTS=()
          while IFS= read -r branch_root; do
            # Skip empty lines
            [[ -z "$branch_root" ]] && continue

            VALID=false
            for valid_root in "${VALID_ROOTS[@]}"; do
              if [ "$branch_root" = "$valid_root" ]; then
                VALID=true
                break
              fi
            done

            if [ "$VALID" = false ]; then
              INVALID_ROOTS+=("$branch_root")
            fi
          done <<< "$BRANCH_ROOTS"

          # If any invalid roots found, fail
          if [ ${#INVALID_ROOTS[@]} -gt 0 ]; then
            echo "‚ùå ERROR: This branch contains invalid root commits"
            echo ""
            echo "Expected all root commits to be one of:"
            for root in "${VALID_ROOTS[@]}"; do
              echo "  - $root"
            done
            echo ""
            echo "Found invalid root commit(s):"
            for invalid in "${INVALID_ROOTS[@]}"; do
              echo "  - $invalid"
            done
            echo ""
            echo "This repository was re-initialized to remove sensitive data from git history."
            echo "Branches must be created from the current dev/main branches."
            echo ""
            echo "To fix this:"
            echo "1. Save your changes as a patch: git diff origin/dev > my-changes.patch"
            echo "2. Create a fresh branch from current dev: git checkout -b my-branch origin/dev"
            echo "3. Apply your patch: git apply my-changes.patch"
            echo "4. Commit and push the clean branch"
            echo "5. Delete this branch: git push origin --delete ${{ github.ref_name }}"
            echo ""
            echo "Contact @${{ env.SECURITY_CONTACT }} if you need assistance."

            # Save invalid roots for issue creation
            echo "invalid_roots=${INVALID_ROOTS[*]}" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "‚úÖ Branch ancestry validation passed"

      - name: Create issue for invalid branch
        if: failure() && steps.check_ancestry.outcome == 'failure' && (github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository)
        uses: actions/github-script@v7
        with:
          script: |
            const branch = context.eventName === 'pull_request'
              ? context.payload.pull_request.head.ref
              : context.ref.replace('refs/heads/', '');
            const pusher = context.actor;
            const invalidRoots = '${{ steps.check_ancestry.outputs.invalid_roots }}';

            // Check for existing open issues about this branch
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security',
              per_page: 100
            });

            const branchIssueExists = existingIssues.data.some(issue =>
              issue.title.includes(`Branch ${branch} contains invalid git history`)
            );

            if (branchIssueExists) {
              console.log(`Issue already exists for branch ${branch}, skipping creation`);
              return;
            }

            try {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `‚ö†Ô∏è Branch ${branch} contains invalid git history`,
                assignees: [pusher],
                labels: ['security', 'urgent'],
                body: `## ‚ö†Ô∏è URGENT: Invalid Git History Detected

**Branch:** \`${branch}\`
**Pushed by:** @${pusher}
**Invalid root commit(s):** \`${invalidRoots}\`

This branch contains git history from before the repository re-initialization and must be deleted immediately to prevent exposure of sensitive data.

### Required Actions:

1. **Save your work:**
   \`\`\`bash
   git diff origin/dev > my-changes.patch
   \`\`\`

2. **Delete this branch:**
   \`\`\`bash
   git push origin --delete ${branch}
   \`\`\`

3. **Create a clean branch:**
   \`\`\`bash
   git checkout -b ${branch} origin/dev
   git apply my-changes.patch
   git add .
   git commit -m "Re-apply changes on clean branch"
   git push -u origin ${branch}
   \`\`\`

**This branch will be blocked from merging to dev/main.**

Contact @${{ env.SECURITY_CONTACT }} if you need assistance.

---
*Automated alert from [Validate Branch History workflow](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})*`
              });

              console.log('Issue created successfully');
            } catch (error) {
              console.error('Failed to create issue:', error.message);

              // Fallback: Create without assignee or labels if they fail
              try {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: `‚ö†Ô∏è Branch ${branch} contains invalid git history`,
                  body: `## ‚ö†Ô∏è URGENT: Invalid Git History Detected

**Branch:** \`${branch}\`
**Pushed by:** @${pusher}
**Invalid root commit(s):** \`${invalidRoots}\`

This branch contains git history from before the repository re-initialization and must be deleted immediately to prevent exposure of sensitive data.

Contact @${{ env.SECURITY_CONTACT }} for assistance.

---
*Automated alert from [Validate Branch History workflow](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})*

_Note: Failed to assign or add labels due to: ${error.message}_`
                });
                console.log('Fallback issue created without assignee/labels');
              } catch (fallbackError) {
                console.error('Fallback issue creation also failed:', fallbackError.message);
              }
            }
