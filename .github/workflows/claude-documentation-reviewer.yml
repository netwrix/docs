name: Documentation Reviewer

on:
  pull_request_target:
    types: [opened, edited, reopened, synchronize]
    paths:
      - '**.md'

jobs:
  claude-response:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Check out by SHA to prevent TOCTOU attacks from forks.
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Get changed markdown files
        id: changed-files
        run: |
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          CHANGED_MD_FILES=$(git diff --name-only --diff-filter=ACMRT $BASE_SHA $HEAD_SHA | grep '\.md$' || true)
          if [ -z "$CHANGED_MD_FILES" ]; then
            echo "No markdown files changed"
            echo "files=" >> "$GITHUB_OUTPUT"
            echo "count=0" >> "$GITHUB_OUTPUT"
          else
            echo "Changed markdown files:"
            echo "$CHANGED_MD_FILES"
            FILES_LIST=$(echo "$CHANGED_MD_FILES" | tr '\n' ',' | sed 's/,$//')
            echo "files=$FILES_LIST" >> "$GITHUB_OUTPUT"
            echo "count=$(echo "$CHANGED_MD_FILES" | wc -l | tr -d ' ')" >> "$GITHUB_OUTPUT"
          fi

      - name: Delete existing review comment
        if: steps.changed-files.outputs.count > 0
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          COMMENT_IDS=$(gh api repos/${{ github.repository }}/issues/${PR_NUMBER}/comments \
            --jq '[.[] | select(.user.login == "github-actions[bot]") | select(.body | startswith("## Documentation Review")) | .id] | .[]' 2>/dev/null || true)
          for ID in $COMMENT_IDS; do
            gh api repos/${{ github.repository }}/issues/comments/${ID} -X DELETE || true
          done

      - name: Checkout system prompt repository
        uses: actions/checkout@v4
        with:
          repository: netwrix-eng/internal-agents
          token: ${{ secrets.PRIVATE_AGENTS_REPO }}
          path: system-prompt-repo
          ref: builds
          sparse-checkout: |
            engineering/technical_writing/system-prompt.md
          sparse-checkout-cone-mode: false

      - name: Read system prompt
        id: read-prompt
        run: |
          {
            echo "prompt<<EOF"
            cat system-prompt-repo/engineering/technical_writing/system-prompt.md
            echo "" # Forces a newline to prevent EOF delimiter errors
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Run documentation review
        if: steps.changed-files.outputs.count > 0
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          show_full_output: true
          prompt: |
            Review ONLY the following markdown files that were changed in this PR: ${{ steps.changed-files.outputs.files }}

            Use `gh pr diff ${{ github.event.pull_request.number }}` to see the exact changes made.

            Do not review or comment on any other files (e.g., .js, .ts, .json, etc.). Focus exclusively on the documentation changes in the markdown files listed above.

            Write your findings to /tmp/suggestions.json following the format in your instructions.

          claude_args: |
            --model claude-sonnet-4-5-20250929
            --allowedTools "Write,Bash(gh pr diff:*),Bash(gh pr view:*)"
            --append-system-prompt "${{ steps.read-prompt.outputs.prompt }}"

      - name: Post inline suggestions
        if: steps.changed-files.outputs.count > 0
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          REPO: ${{ github.repository }}
        run: |
          python3 << 'PYEOF'
          import subprocess, json, os, sys

          pr_number = os.environ['PR_NUMBER']
          head_sha = os.environ['HEAD_SHA']
          repo = os.environ['REPO']

          try:
              with open('/tmp/suggestions.json') as f:
                  data = json.load(f)
          except (FileNotFoundError, json.JSONDecodeError) as e:
              print(f"Could not read /tmp/suggestions.json: {e}")
              sys.exit(1)

          # Handle case where Claude wraps the array in an object
          if isinstance(data, dict):
              for key in data:
                  if isinstance(data[key], list):
                      data = data[key]
                      break
              else:
                  print(f"Unexpected dict structure: {list(data.keys())}")
                  sys.exit(1)

          if not isinstance(data, list):
              print(f"Expected array, got {type(data)}")
              sys.exit(1)

          suggestions = data

          if not suggestions:
              subprocess.run(
                  ['gh', 'pr', 'comment', pr_number, '--repo', repo,
                   '--body', 'No issues found in the changed files.'],
                  check=True
              )
              print("No issues found")
              sys.exit(0)

          comments = []
          for s in suggestions:
              if not isinstance(s, dict):
                  print(f"Skipping non-object suggestion: {repr(s)[:100]}")
                  continue
              # Accept alternate field names Claude may use
              path = s.get('path') or s.get('file')
              line = s.get('line') or s.get('line_number')
              body_text = s.get('body') or s.get('issue') or s.get('description') or ''
              suggestion_text = s.get('suggestion') or s.get('replacement') or s.get('fix') or ''
              start_line = s.get('start_line') or s.get('start') or line
              if not path or not line or not suggestion_text:
                  print(f"Skipping incomplete suggestion: {repr(s)[:100]}")
                  continue
              body = body_text + '\n```suggestion\n' + suggestion_text + '\n```'
              c = {'path': path, 'line': line, 'side': 'RIGHT', 'body': body}
              if start_line and start_line != line:
                  c['start_line'] = start_line
                  c['start_side'] = 'RIGHT'
              comments.append(c)

          if not comments:
              print("No valid suggestions to post")
              sys.exit(1)

          review_data = {
              'commit_id': head_sha,
              'body': f'Found {len(comments)} issue(s). To apply all fixes at once, reply with `@claude` followed by your instructions (e.g. `@claude fix all issues`).',
              'event': 'COMMENT',
              'comments': comments
          }

          r = subprocess.run(
              ['gh', 'api', f'repos/{repo}/pulls/{pr_number}/reviews',
               '--method', 'POST', '--input', '-'],
              input=json.dumps(review_data).encode(),
              capture_output=True
          )
          if r.returncode != 0:
              print(f"Error posting suggestions: {r.stderr.decode()}")
              sys.exit(1)
          print(f"Posted {len(comments)} inline suggestion(s)")
          PYEOF
